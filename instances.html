<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commonshub — Test Instances</title>

<style>
:root{
  --bg:#f4f7f5;
  --card:#ffffff;
  --text:#102018;
  --muted:#5b6f63;
  --line:#d9e2dc;
  --accent:#1f6f4a;
  --radius:16px;
  --font: ui-sans-serif, system-ui;
}
body{margin:0;font-family:var(--font);background:var(--bg);color:var(--text);}
.wrap{max-width:920px;margin:auto;padding:28px 18px;}
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;gap:12px;}
h1{font-size:20px;margin:0;}
button{
  border:none;border-radius:10px;padding:10px 14px;
  font-weight:600;cursor:pointer;
}
.primary{background:var(--accent);color:#fff;}
.secondary{background:#fff;border:1px solid var(--line);}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:18px;
}
.row{
  display:flex;justify-content:space-between;align-items:center;
  gap:12px;
  padding:12px 0;border-bottom:1px solid var(--line);
}
.row:last-child{border-bottom:none;}
.meta{font-size:13px;color:var(--muted);}
.actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
input{
  padding:10px;border-radius:10px;border:1px solid var(--line);width:100%;
}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.25);
  display:none;align-items:center;justify-content:center;
}
.modalCard{background:#fff;padding:20px;border-radius:14px;width:320px;}
.badge{
  display:inline-flex;
  align-items:center;
  padding:3px 8px;
  border-radius:999px;
  font-size:12px;
  color:var(--muted);
  border:1px solid var(--line);
  background:rgba(31,111,74,.06);
  margin-left:8px;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <h1>Your test servers</h1>
    <div style="display:flex;gap:10px;">
      <button class="secondary" onclick="window.location.href='flow-diagram.html'">Back</button>
      <button class="primary" onclick="openModal()">Create test server</button>
    </div>
  </div>

  <div class="card" id="instanceList"></div>

</div>

<!-- CREATE MODAL -->
<div class="modal" id="modal">
  <div class="modalCard">
    <h3 style="margin:0 0 10px;">Create test server</h3>
    <div class="meta">Name</div>
    <input id="name" placeholder="PeakX test" />
    <div class="meta" style="margin-top:10px;">Subdomain</div>
    <input id="slug" placeholder="peakx-test" />

    <div style="display:flex;gap:10px;margin-top:14px;">
      <button class="primary" onclick="createInstance()">Create</button>
      <button class="secondary" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
const list = document.getElementById("instanceList");

// Pinned “real” instance (no localStorage needed)
const PINNED = {
  name: "PeakX",
  domain: "peakx.social",
  status: "Live",
  openHref: "instance-dashboard.html"
};

function load(){
  const data = JSON.parse(localStorage.getItem("instances") || "[]");
  list.innerHTML = "";

  // 1) Always show pinned PeakX row first
  list.appendChild(renderRow({
    name: PINNED.name,
    sub: PINNED.domain,
    status: PINNED.status,
    badge: "Pinned",
    onOpen: () => { window.location.href = PINNED.openHref; },
    onDelete: null
  }));

  // 2) Then show any mock-created instances
  if(!data.length){
    const empty = document.createElement("div");
    empty.className = "meta";
    empty.style.marginTop = "10px";
    empty.textContent = "No other test servers yet.";
    list.appendChild(empty);
    return;
  }

  data.forEach((i,idx)=>{
    list.appendChild(renderRow({
      name: i.name,
      sub: `${i.slug}.commonshub.social`,
      status: i.status || "Live",
      badge: "Mock",
      onOpen: () => openInstance(idx),
      onDelete: () => deleteInstance(idx)
    }));
  });
}

function renderRow({name, sub, status, badge, onOpen, onDelete}){
  const row = document.createElement("div");
  row.className="row";

  const left = document.createElement("div");
  left.innerHTML = `<b>${escapeHtml(name)}</b>${badge ? `<span class="badge">${escapeHtml(badge)}</span>` : ""}
                   <div class="meta">${escapeHtml(sub)} · ${escapeHtml(status)}</div>`;

  const actions = document.createElement("div");
  actions.className = "actions";

  const openBtn = document.createElement("button");
  openBtn.className = "secondary";
  openBtn.textContent = "Open";
  openBtn.addEventListener("click", onOpen);
  actions.appendChild(openBtn);

  if (onDelete){
    const delBtn = document.createElement("button");
    delBtn.className = "secondary";
    delBtn.textContent = "Delete";
    delBtn.addEventListener("click", onDelete);
    actions.appendChild(delBtn);
  }

  row.appendChild(left);
  row.appendChild(actions);
  return row;
}

function createInstance(){
  const nameInput = document.getElementById("name");
  const slugInput = document.getElementById("slug");

  const name = (nameInput.value || "").trim();
  const slug = (slugInput.value || "").trim();

  if(!name || !slug) return;

  const data = JSON.parse(localStorage.getItem("instances") || "[]");
  data.push({ name, slug, status:"Live" });
  localStorage.setItem("instances", JSON.stringify(data));

  nameInput.value = "";
  slugInput.value = "";

  closeModal();
  load();
}

function deleteInstance(i){
  const data = JSON.parse(localStorage.getItem("instances") || "[]");
  data.splice(i,1);
  localStorage.setItem("instances", JSON.stringify(data));
  load();
}

function openInstance(i){
  // For now: everything opens the same “manual setup links” dashboard.
  // Later: you can store active index + render domain-specific links.
  window.location.href = "instance-dashboard.html";
}

function openModal(){ document.getElementById("modal").style.display="flex"; }
function closeModal(){ document.getElementById("modal").style.display="none"; }

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

load();
</script>
</body>
</html>
